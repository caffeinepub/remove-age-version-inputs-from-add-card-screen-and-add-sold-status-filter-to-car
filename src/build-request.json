{
  "kind": "build_request",
  "title": "Fix post-login backend connection failure in live deployment",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Fix secret URL parameter parsing so the app can reliably read `caffeineAdminToken` from hash-based routes (e.g. `#/someRoute?caffeineAdminToken=...`) as well as from pure hash query formats (e.g. `#caffeineAdminToken=...`), and persist the extracted token in `sessionStorage` as intended.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-12"
        ],
        "quotes": [
          "Nach liveschaltung kommt nach anmeldung eine fehlermeldung. Connection to the backend could not be established"
        ]
      },
      "acceptanceCriteria": [
        "When the URL contains `#/anything?caffeineAdminToken=XYZ`, `getSecretParameter('caffeineAdminToken')` returns `XYZ` and stores it in sessionStorage.",
        "When the URL contains `#caffeineAdminToken=XYZ`, `getSecretParameter('caffeineAdminToken')` returns `XYZ` and stores it in sessionStorage.",
        "After extraction, the token is removed from the visible URL (hash) without reloading the page (existing behavior preserved).",
        "If no token is present, `getSecretParameter('caffeineAdminToken')` returns null and does not throw."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Persist the `caffeineAdminToken` before an Internet Identity login redirect can remove it from the URL by proactively extracting/storing it during initial app load (before the user clicks login).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-12"
        ],
        "quotes": [
          "After live deployment, login fails with error: \"Connection to the backend could not be established\"."
        ]
      },
      "acceptanceCriteria": [
        "On first render of the app (unauthenticated), the app attempts to extract `caffeineAdminToken` and store it in sessionStorage without showing any errors to the user.",
        "After completing Internet Identity login, backend actor initialization succeeds in live deployment when a valid `caffeineAdminToken` was present before redirect.",
        "If the token was not present, behavior remains unchanged (no crashes; existing error/timeout UI still works)."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Improve the backend connection error state to surface the underlying actor initialization error in a user-readable way (English), including a short suggested action, while keeping sensitive tokens out of the UI.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-12"
        ],
        "quotes": [
          "Connection to the backend could not be established"
        ]
      },
      "acceptanceCriteria": [
        "If actor initialization fails, the UI shows an English error message with at least one actionable next step (e.g., retry, reload, log out/in).",
        "If an error message is available from the actor query, it is shown in the error details area (as today) but must not include any extracted URL/session secret values."
      ]
    }
  ],
  "constraints": [
    "Do not edit files under `frontend/src/hooks/useInternetIdentity.ts`/`.tsx`, `frontend/src/hooks/useActor.ts`, `frontend/src/hooks/useActor.tsx`, `frontend/src/main.tsx`, or anything in `frontend/src/components/ui` (immutable paths).",
    "Use English for any user-facing text changed or added as part of this fix."
  ],
  "nonGoals": [
    "Adding new authentication providers (only Internet Identity).",
    "Changing backend authorization rules or data schema unless proven necessary to resolve the connection failure."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}